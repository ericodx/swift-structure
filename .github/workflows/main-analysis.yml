name: main-analysis

on:
  push:
    branches: [ main ]

jobs:
  # Tests And Coverage
  test-and-coverage:
    runs-on: macos-26
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2.3"

      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Prepare directories
        run: |
          mkdir -p coverage

      - name: Run tests and generate coverage
        run: |
          set -e

          echo "Running tests with coverage..."
          swift test --enable-code-coverage --quiet

          BIN_PATH=$(swift build --show-bin-path)

          TEST_BINARY=$(find "$BIN_PATH" -type f \
            -path "*Tests.xctest/Contents/MacOS/*" \
            ! -path "*.dSYM/*" \
            | head -n 1)

          if [ -z "$TEST_BINARY" ]; then
            echo "Test binary not found"
            exit 1
          fi

          PROFDATA="$BIN_PATH/codecov/default.profdata"

          echo "Generating LCOV..."

          xcrun llvm-cov export \
            "$TEST_BINARY" \
            -instr-profile "$PROFDATA" \
            --sources "$(pwd)/Sources" \
            --format=lcov \
          | sed "s|$(pwd)/||g" \
          > coverage/lcov.info

          echo "Converting LCOV â†’ Sonar Generic XML..."

          echo '<coverage version="1">' > coverage/code-coverage-report.xml

          awk '
            /^SF:/ {
              file = substr($0,4);
              if (file ~ /^Sources\/.*\.swift$/) {
                current_file = file;
                print "  <file path=\"" current_file "\">";
                inside = 1;
              } else {
                inside = 0;
              }
            }

            inside && /^DA:/ {
              split($0,a,",");
              line = substr(a[1],4);
              covered = (a[2] > 0 ? "true" : "false");
              print "    <lineToCover lineNumber=\"" line "\" covered=\"" covered "\"/>";
            }

            inside && /^end_of_record/ {
              print "  </file>";
            }
          ' coverage/lcov.info >> coverage/code-coverage-report.xml

          echo '</coverage>' >> coverage/code-coverage-report.xml

          echo "Coverage generated"

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/

  # Static Analysis
  static-analysis:
    runs-on: macos-26

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2.3"

      - name: Install analysis tools
        run: |
          brew update
          brew install swiftlint gitleaks periphery

      - name: Prepare directories
        run: mkdir -p reports

      - name: Run SwiftLint
        run: |
          swiftlint lint \
            --reporter sonarqube \
            > reports/swiftlint.json || true

          # Convert to SonarCloud Clean Code format
          jq '{
            rules: [.issues | group_by(.ruleId)[] | .[0] | {
              id: .ruleId,
              name: .ruleId,
              description: .message,
              engineId: "swiftlint",
              cleanCodeAttribute: "CONVENTIONAL",
              impacts: [{
                softwareQuality: "MAINTAINABILITY",
                severity: "MEDIUM"
              }]
            }],
            issues: [.issues[] | {
              ruleId: .ruleId,
              effortMinutes: 5,
              primaryLocation: {
                message: .message,
                filePath: .location.path,
                textRange: {
                  startLine: .location.range.start.line,
                  startColumn: .location.range.start.column,
                  endLine: .location.range.end.line,
                  endColumn: .location.range.end.column
                }
              }
            }]
          }' reports/swiftlint.json > reports/linter-report.json || true

      - name: Run Periphery
        run: |
          periphery scan \
            --format json \
            > reports/periphery.json || true

          # Convert to SonarCloud Clean Code format
          if [ -f reports/periphery.json ]; then
            jq '{
              rules: [{
                id: "unused-code",
                name: "Unused Code",
                description: "Code that is never used and can be removed",
                engineId: "periphery",
                cleanCodeAttribute: "FOCUSED",
                impacts: [{
                  softwareQuality: "MAINTAINABILITY",
                  severity: "HIGH"
                }]
              }],
              issues: map({
                ruleId: "unused-code",
                effortMinutes: 10,
                primaryLocation: {
                  message: (.message // "unused code"),
                  filePath: .file,
                  textRange: {
                    startLine: (.line // 1),
                    startColumn: (.column // 1),
                    endLine: (.line // 1),
                    endColumn: ((.column // 1) + 1)
                  }
                }
              })
            }' reports/periphery.json > reports/dead-code-report.json
          fi

      - name: Run Gitleaks
        run: |
          gitleaks detect \
            --report-path reports/leaks-report.sarif \
            --report-format sarif || true

      - name: Upload analysis reports
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports/

  # Publish Code Analysis
  publish-code-analysis:
    runs-on: ubuntu-latest
    needs: [test-and-coverage, static-analysis]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          name: coverage
          path: coverage

      - name: Download reports artifacts
        uses: actions/download-artifact@v4
        with:
          name: reports
          path: reports

      - name: Publish Code Analysis
        if: env.SONAR_TOKEN != ''
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
