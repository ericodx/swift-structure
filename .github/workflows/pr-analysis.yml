name: pull-request-analysis

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  pull-request-analysis:
    runs-on: macos-26
    timeout-minutes: 30

    steps:
      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Swift Toolchain
      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2"

      # Cache SwiftPM
      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # Prepare Directories
      - name: Prepare directories
        run: |
          mkdir -p reports
          mkdir -p coverage

      # Install Tools
      - name: Install analysis tools
        run: |
          brew update
          brew install swiftlint gitleaks jq periphery bc

      # Tests and Coverage
      - name: Run tests and generate coverage
        run: |
          set -e

          echo "Running tests with coverage..."
          swift test --enable-code-coverage --quiet

          BIN_PATH=$(swift build --show-bin-path)

          TEST_BINARY=$(find "$BIN_PATH" -type f \
            -path "*Tests.xctest/Contents/MacOS/*" \
            ! -path "*.dSYM/*" \
            | head -n 1)

          if [ -z "$TEST_BINARY" ]; then
            echo "X Test binary not found"
            exit 1
          fi

          PROFDATA="$BIN_PATH/codecov/default.profdata"

          echo "Generating LCOV..."

          xcrun llvm-cov export \
            "$TEST_BINARY" \
            -instr-profile "$PROFDATA" \
            --sources "$(pwd)/Sources" \
            --format=lcov \
          | sed "s|$(pwd)/||g" \
          > coverage/lcov.info

          echo "âœ“ Coverage generated"

      # SwiftLint
      - name: Run SwiftLint
        run: |
          swiftlint lint \
            --reporter json \
            > reports/swiftlint.json || true

      # Periphery
      - name: Run Periphery
        run: |
          periphery scan \
            --format json \
            --skip-build \
            > reports/periphery.json || true

      # Gitleaks
      - name: Run Gitleaks
        run: |
          gitleaks detect \
            --report-path reports/gitleaks.sarif \
            --report-format sarif || true

      # Coverage Quality Gate
      - name: Coverage Quality Gate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          THRESHOLD=80

          TOTAL=$(grep -o "LF:[0-9]*" coverage/lcov.info | awk -F: '{s+=$2} END {print s}')
          HIT=$(grep -o "LH:[0-9]*" coverage/lcov.info | awk -F: '{s+=$2} END {print s}')

          if [ -z "$TOTAL" ] || [ "$TOTAL" -eq 0 ]; then
            COVERAGE=0
          else
            COVERAGE=$(echo "scale=2; ($HIT/$TOTAL)*100" | bc)
          fi

          echo "Coverage: $COVERAGE%"

          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            STATE="failure"
            STATUS_ICON="X"
            STATUS_TEXT="Below threshold"
          else
            STATE="success"
            STATUS_ICON="âœ…"
            STATUS_TEXT="OK"
          fi

          COMMENT="### ðŸ“Š Coverage Report

          | Metric | Value |
          |--------|-------|
          | Coverage | **$COVERAGE%** |
          | Threshold | **$THRESHOLD%** |
          | Status | $STATUS_ICON $STATUS_TEXT |
          "

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            -d "$(jq -nc --arg body "$COMMENT" '{body: $body}')"

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -d "{
              \"state\": \"$STATE\",
              \"context\": \"quality-gate/coverage\",
              \"description\": \"Coverage: $COVERAGE%\"
            }"

          echo "âœ“ Coverage gate finished (state=$STATE)"

      # Artifacts
      - name: Upload analysis reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-analysis-reports
          path: |
            reports/
            coverage/
          retention-days: 30
